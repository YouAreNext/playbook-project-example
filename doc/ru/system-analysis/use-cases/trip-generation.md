### **Сценарий Использования (Use Case)**

**ID:** UC-01
**Название сценария:** Генерация персонализированного маршрута путешествия

**Участники (Actors):**
*   **Пользователь:** Инициатор процесса, который вводит запрос и получает результат.
*   **Система "Localize":** Приложение, которое обрабатывает запрос, оркестрирует процесс и предоставляет интерфейс.
*   **Внешний AI-сервис:** Сторонняя система (например, OpenAI API), которая генерирует текстовое описание маршрута.

**Предусловия (Preconditions):**
1.  Пользователь успешно аутентифицирован в Системе.
2.  Пользователь находится на экране, где доступно поле для ввода запроса на создание маршрута (например, главный дашборд).

---

### **Основной успешный сценарий (Main Success Scenario):**

| Шаг | Действие Пользователя | Действие Системы "Localize" |
| :-- | :--- | :--- |
| 1 | Вводит текстовый запрос в соответствующее поле (например, "Хочу в Рим на 7 дней в октябре. Интересует история, нетуристические рестораны. Бюджет средний.") | |
| 2 | Нажимает кнопку "Создать план" (или аналогичную). | 2.1. Принимает HTTP-запрос от клиентского приложения. <br>2.2. Валидирует входные данные: проверяет, что пользователь аутентифицирован и что длина текста не превышает 1000 символов. <br>2.3. Создает в базе данных новую запись о маршруте с уникальным ID и статусом `PROCESSING`. |
| 3 | | 3.1. Помещает задачу на генерацию в асинхронную очередь сообщений, передавая ID маршрута и текст запроса. <br>3.2. **Немедленно** отправляет клиенту ответ `HTTP 202 Accepted`, подтверждая, что задача принята в обработку. |
| 4 | Наблюдает на экране индикатор загрузки ("Ваш маршрут генерируется..."). | 4.1. Клиентское приложение, получив ответ `202`, отображает индикатор загрузки. <br>4.2. Клиентское приложение устанавливает WebSocket-соединение для получения уведомления о завершении. |
| 5 | | 5.1. **(Асинхронно)** Воркер забирает задачу из очереди. <br>5.2. Формирует детализированный промпт для **Внешнего AI-сервиса**. <br>5.3. Отправляет запрос к **Внешнему AI-сервису** и ожидает ответа. |
| 6 | | 6.1. Получает текстовый ответ от **Внешнего AI-сервиса**. <br>6.2. Парсит ответ, преобразуя его в структурированные данные (дни, локации, время, описания, координаты). <br>6.3. Обновляет запись о маршруте в базе данных, сохраняя структурированные данные и меняя статус на `COMPLETED`. |
| 7 | | 7.1. Отправляет по WebSocket-каналу уведомление клиенту о том, что маршрут с конкретным ID готов. |
| 8 | | 8.1. Клиентское приложение получает уведомление. <br>8.2. Автоматически отправляет новый HTTP GET-запрос для получения данных готового маршрута по его ID. |
| 9 | Видит на экране полностью сгенерированный маршрут, представленный в виде списка по дням и отмеченный на интерактивной карте. | 9.1. Получает данные маршрута. <br>9.2. Скрывает индикатор загрузки. <br>9.3. Отображает полученную информацию в пользовательском интерфейсе. |

---

### **Альтернативные сценарии и исключения (Extensions):**

**2a. Ошибка валидации: Пустой запрос**
*   **Триггер:** На шаге 2 Пользователь нажимает кнопку "Создать план", не введя текст в поле запроса.
*   **Сценарий:**
    1.  Система на стороне клиента (Frontend) определяет, что поле пустое.
    2.  Система отображает сообщение об ошибке рядом с полем ввода (например, "Пожалуйста, опишите ваше путешествие").
    3.  Запрос на сервер не отправляется. Процесс завершается.

**2b. Ошибка валидации: Превышен лимит символов**
*   **Триггер:** На шаге 2 Пользователь вводит текст, длина которого превышает 1000 символов.
*   **Сценарий:**
    1.  Система (на стороне клиента или сервера) определяет, что лимит превышен.
    2.  Система отклоняет запрос и отображает Пользователю сообщение об ошибке (например, "Запрос слишком длинный. Максимум 1000 символов").
    3.  Процесс завершается.

**5a. Ошибка внешнего AI-сервиса**
*   **Триггер:** На шаге 5.3 Внешний AI-сервис недоступен, возвращает ошибку (статус 5xx) или истекает тайм-аут ожидания.
*   **Сценарий:**
    1.  Система "Localize" (Воркер) фиксирует ошибку.
    2.  Система обновляет запись о маршруте в базе данных, устанавливая статус `FAILED` и сохраняя информацию об ошибке.
    3.  Система отправляет по WebSocket-каналу уведомление клиенту об ошибке генерации.
    4.  Клиентское приложение, получив уведомление, скрывает индикатор загрузки и отображает Пользователю сообщение (например, "Не удалось создать маршрут. Попробуйте позже").
    5.  Процесс завершается.

**6a. Ошибка парсинга ответа AI**
*   **Триггер:** На шаге 6.2 Внешний AI-сервис вернул ответ в формате, который Система не может распознать и преобразовать в структурированные данные.
*   **Сценарий:**
    1.  Система "Localize" (Воркер) не может распарсить ответ.
    2.  Дальнейшие шаги аналогичны сценарию **5a**: статус `FAILED`, уведомление пользователя об ошибке.

**A. Пользователь покидает страницу во время генерации**
*   **Триггер:** После шага 4 Пользователь закрывает вкладку браузера или переходит на другую страницу.
*   **Сценарий:**
    1.  WebSocket-соединение разрывается.
    2.  Процесс генерации на стороне бэкенда (шаги 5-6) **продолжается** в фоновом режиме.
    3.  Когда Пользователь вернется в приложение, он увидит готовый маршрут в списке своих путешествий (если он успешно сгенерировался) или сможет увидеть уведомление об ошибке. Система не теряет результат работы.